name: Cleanup Old Prereleases (Dry Run)

on:
  workflow_dispatch: # Manual trigger only

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: read # Read-only for safety

    steps:
      - name: Check and Log Old Releases
        uses: actions/github-script@v7
        with:
          script: |
            // 1. Calculate the cutoff date (2 months ago)
            const cutoffDate = new Date();
            cutoffDate.setMonth(cutoffDate.getMonth() - 2);
            console.log(`üìÖ Cutoff date: ${cutoffDate.toISOString()}`);

            // 2. Fetch all releases (using pagination to catch everything)
            const releases = await github.paginate(github.rest.repos.listReleases, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            console.log(`üîç Total releases found: ${releases.length}`);

            let toDeleteCount = 0;

            // 3. Iterate through releases
            for (const release of releases) {
              const releaseDate = new Date(release.created_at);
              const name = release.name || "";
              const tag = release.tag_name || "";
              
              // Check for keywords (case-insensitive)
              const hasKeywords = /(prerelease|beta)/i.test(name) || /(prerelease|beta)/i.test(tag);
              
              // Check if older than cutoff
              const isOld = releaseDate < cutoffDate;

              if (hasKeywords && isOld) {
                console.log(`‚ö†Ô∏è [WOULD DELETE] Release: "${name}" (Tag: ${tag}) | Created: ${release.created_at}`);
                toDeleteCount++;
                
                // Actual deletion logic (commented out):
                // await github.rest.repos.deleteRelease({ owner: context.repo.owner, repo: context.repo.repo, release_id: release.id });
                // await github.rest.git.deleteRef({ owner: context.repo.owner, repo: context.repo.repo, ref: `tags/${tag}` });
              }
            }

            if (toDeleteCount === 0) {
              console.log("‚úÖ No matching releases found for deletion.");
            } else {
              console.log(`üî¥ Total candidates for deletion: ${toDeleteCount}`);
            }